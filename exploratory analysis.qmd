---
title: "Exploratory analysis"
format: html
editor: source
---


```{r}
source("scripts/library_and_data_import.R")
source("scripts/china_us_flight_data_wrangling.R")
```


## All U.S. Carriers

### Extracting dataset

```{r}
#| label: us-carriers-extract

## Passenger flights only

df_us_carriers <- df_all %>% 
  filter(
    CARRIER %in% c(
      "F9", "AA", "B6", "DL", "UA", "NK", "AS", "WN"
    ),
    CLASS == "F"
  ) %>% 
  select(
    DEPARTURES_SCHEDULED, DEPARTURES_PERFORMED, SEATS, PASSENGERS,
    DISTANCE, CARRIER, REGION, ORIGIN, ORIGIN_STATE_ABR,
    DEST, DEST_STATE_ABR, AIRCRAFT_TYPE, YEAR, MONTH
  ) %>% 
  left_join(aircraft_type_map, by = "AIRCRAFT_TYPE") %>% 
  select(
    -AIRCRAFT_TYPE,
    -AIRCRAFT
  ) %>% 
  rename(
    AIRCRAFT = AIRCRAFT_NORMALIZED
  ) %>% 
  mutate(
    CARRIER_TYPE = case_when(
      CARRIER %in% c("F9", "NK") ~ "Ultra low cost carrier",
      CARRIER %in% c("B6", "WN") ~ "Low cost carrier",
      CARRIER %in% c("AA", "DL", "UA", "AS") ~ "Full service carrier",
      TRUE ~ NA
    )
  )

```

### RDU Analysis

```{r}
#| label: rdu-flight-trends

df_rdu_us_carriers <- df_us_carriers %>% 
  filter(
    ORIGIN == "RDU" | DEST == "RDU", 
    DEPARTURES_PERFORMED > 0,
    DEPARTURES_SCHEDULED > 3,
    PASSENGERS > 5
  )

df_rdu_us_carrier_routes <- df_rdu_us_carriers %>% 
  group_by(YEAR, CARRIER, CARRIER_TYPE, ORIGIN, DEST, DISTANCE) %>% 
  summarise(
    departures = sum(DEPARTURES_PERFORMED, na.rm = TRUE),
    passengers = sum(PASSENGERS, na.rm = TRUE),
    seats = sum(SEATS, na.rm = TRUE)
  ) %>% 
  mutate(
    other_airport = case_when(
      ORIGIN != "RDU" ~ ORIGIN,
      DEST != "RDU" ~ DEST,
      TRUE ~ NA_character_
    )
  ) %>% 
  filter(!(is.na(other_airport))) %>% 
  group_by(YEAR, other_airport, CARRIER_TYPE, CARRIER, DISTANCE) %>% 
  summarise(
    departures = sum(departures),
    passengers = sum(passengers),
    seats = sum(seats),
    .groups = "drop"
  ) %>% 
  mutate(
    load_factor_airline_per_route_per_year = passengers / seats * 100,
    capacity_per_departure = seats / departures,
    passenger_per_departure = passengers / departures
  )


df_rdu_us_carrier_routes_competition <- df_rdu_us_carrier_routes %>% 
  group_by(YEAR, other_airport) %>%
  mutate(
    competitor_same_year = n_distinct(CARRIER) - 1L,
    ULCC_present = any(CARRIER_TYPE == "Ultra low cost carrier", na.rm = TRUE),
    load_factor_route_year = if_else(
      sum(seats, na.rm = TRUE) > 0,
      100 * sum(passengers, na.rm = TRUE) / sum(seats, na.rm = TRUE),
      NA_real_
    )
  ) %>%
  ungroup()

```

### Air fare analysis

```{r}

rdu_ny_airfare <- airfare %>% filter(
  citymarketid_1 == 31703,
  citymarketid_2 == 34492
)


airfare <- airfare %>% 
  mutate(fare_per_mile = fare / nsmiles)


airfare %>% ggplot(aes(x = large_ms, y = fare_per_mile)) +
  geom_smooth()

cor.test(airfare$large_ms, airfare$fare_per_mile, method = "pearson")

set.seed(1120)

boot_fits <- airfare %>% 
  specify(fare_per_mile ~ large_ms) %>% 
  generate(reps = 1000, type = "bootstrap") %>% 
  fit()

observed_fit <- airfare %>% 
  specify(fare_per_mile ~ large_ms) %>% 
  fit()

get_confidence_interval(
  boot_fits, 
  point_estimate = observed_fit, 
  level = 0.95,
  type = "percentile"
)

fit <- lm(fare_per_mile ~ large_ms, data = airfare)
  

new_case <- tibble(large_ms = 0.9)

predict(fit, new_case, interval = "prediction", 
        level = 0.9)
  
```




