---
title: "Exploratory analysis"
format: html
editor: visual
---

```{r}
#| label: library-import
#| message: FALSE

library(readr)
library(dplyr)
library(ggplot2)
library(data.table)

```




```{r}
#| label: data-import
#| message: FALSE

files <- list.files(
  path = ".",
  pattern = "^[0-9]{4}\\.csv$",
  full.names = TRUE
)

df_all <- lapply(files, read_csv) %>% 
  bind_rows()

aircraft_type_map <- read_csv("L_AIRCRAFT_TYPE.csv") %>% 
  rename(
    AIRCRAFT_TYPE = Code,
    AIRCRAFT = Description
  )

```

```{r}
#| label: china-us-flights-extraction
#| message: FALSE

df_china <- df_all %>% 
  filter(
    ORIGIN_COUNTRY == "CN" | 
      DEST_COUNTRY == "CN" | 
      ORIGIN == "HKG" | 
      DEST == "HKG"
  )

# Filter for scheduled passenger service, and filtering out non-relevant data fields
# Filter for more than 10 passengers on the route in the particular month
# Filtering out airport that we know to not have regularly scheduled U.S.-China passenger service that show up in the data set, like Harbin (HRB) and Pittsburgh (PIT)

no_known_service_airports <- c("HRB", "PIT", "ANC", "MSP", "TUL", "SYR",
                               "STL", "PHL", "PDX", "OKC", "MDT", "KMG",
                               "KHN", "IAG", "HSV", "AFW", "BHM", "BNA", "CDB",
                               "CGO", "CMH", "DLC", "ELP", "GEG", "GRB", "HAK", 
                               "HET", "OKC")

df_china_passenger <- df_china %>% 
  filter(
    CLASS == "F"
  ) %>% select(
    DEPARTURES_SCHEDULED, DEPARTURES_PERFORMED, SEATS, PASSENGERS, DISTANCE,
    AIR_TIME, CARRIER, ORIGIN, DEST, AIRCRAFT_TYPE, YEAR, MONTH
  ) %>% 
  filter(PASSENGERS > 10,
         !(ORIGIN %in% no_known_service_airports),
         !(DEST %in% no_known_service_airports))

unique(df_china_passenger$ORIGIN)
unique(df_china_passenger$DEST)

china_airports <- c("HKG", "PVG", "PEK", "CTU", "HGH", "XIY", "CAN", "WUH",
                    "NKG", "CTU", "SZX", "CSX", "TNA", "TAO", "XIY", "XMN", "CKG",
                    "FOC", "SHE", "TFU")



```



```{r}
#| label: summary-statistics-china-passenger-flight

df_cn_load <- df_china_passenger %>% 
  group_by(YEAR) %>% 
  summarise(
    total_passengers = sum(PASSENGERS),
    total_seats = sum(SEATS)
  ) %>% 
  mutate(
    load_factor = total_passengers / total_seats * 100
  )

df_cn_airlines <- df_china_passenger %>% 
  group_by(CARRIER, YEAR) %>% 
  summarise(
    passenger_by_airline = sum(PASSENGERS)
  )



```


